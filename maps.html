<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Peta Lengkap - DMA + SB + MAP + MAG + RES + GateValve + WO</title>

  <!-- Onsen UI -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsenui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/onsenui/css/onsen-css-components.min.css">
  <script src="https://cdn.jsdelivr.net/npm/onsenui/js/onsenui.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    ons-fab {
      z-index: 1001;
    }
    #gpsInfo {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background-color: rgba(0, 0, 0, 0.5); /* semi-transparent */
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 13px;
      line-height: 1.3;
      z-index: 1000;
      min-width: 150px;
    }
    #gpsInfo p {
      margin: 2px 0; /* jarak antar baris kecil */
    }
     /* Tombol toggle GPS ala Google Maps */
    
  </style>
</head>
<body>

<ons-page id="mapsPage">
<ons-toolbar>
  <div class="left">
    <ons-back-button id="backHome">Back</ons-back-button>
  </div>
  <div class="center">Maps</div>
</ons-toolbar>

<div id="gpsInfo">
  <p id="status">Menunggu lokasi...</p>
  <p id="accuracy"></p>
  <label>
    <input type="checkbox" id="toggleTracking" checked> GPS Tracking
  </label>
</div>



  <div id="map"></div>

    <ons-speed-dial position="bottom right" direction="up">
    <ons-fab>
      <ons-icon icon="md-menu" size="24px"></ons-icon>
    </ons-fab>

    <ons-speed-dial-item id="cameraInput">
      <ons-icon icon="md-search"></ons-icon>
    </ons-speed-dial-item>
    <ons-speed-dial-item>
      <ons-icon icon="md-camera"  onclick="openCamera()"></ons-icon>
    </ons-speed-dial-item>
  </ons-speed-dial>
</ons-page>

<script>
      // Ambil elemen tombol
  const backButton = document.getElementById('backHome');

  // Tambahkan event listener untuk klik
  backButton.addEventListener('click', function() {
    window.location.href = 'index.html'; // Arahkan ke halaman home
  });

let map;
let autoCenter = true; // default ON
// Simpan layer-layer agar bisa dikontrol
let layerDMA, layerSB, layerMAP, layerMAG, layerRES, layerGate, layerMano, layerVentile, layerWO,layerWM;
let layerControl;

// Cache warna zona
const colorCache = {};
function randomColor() {
  const hue = Math.floor(Math.random() * 360);
  return `hsl(${hue}, 70%, 55%)`;
}
function getZoneColor(name) {
  if (!colorCache[name]) colorCache[name] = randomColor();
  return colorCache[name];
}

// Fungsi buat icon PNG
function iconPng(fileName) {
  return L.icon({
    iconUrl: 'icons/' + fileName,  // folder icons/
    iconSize: [28, 28],
    iconAnchor: [14, 28],
    popupAnchor: [0, -25]
  });
}



document.addEventListener('DOMContentLoaded', () => {
  map = L.map('map').setView([-8.525014536114304, 115.32452133504778], 12);

  // Tile dasar
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  
  // Deklarasikan marker **di luar** fungsi success
  marker = L.marker([0,0]).addTo(map);
  
  // === Load tiap layer GeoJSON ===
  loadDMA();
  loadSB();
  loadMAP();
  loadMAG();
  loadRES();
  loadGateValve();
  loadManometer();
//   loadVentile();
//   loadWO();
    loadWMDistribusi();
    loadPipa();

  // Layer Control
  layerControl = L.control.layers(null, null, { collapsed: true }).addTo(map);
});

function iconPng(fileName) {
  return L.icon({
    iconUrl: 'icons/simbol/' + fileName,
    iconSize: [10, 12],        // ðŸ”½ ukuran sangat kecil
    iconAnchor: [4, 10],      // titik tengah bawah
    popupAnchor: [0, -6]     // posisi popup di atas ikon
  });
}
function loadPipa() {
  fetch('geojson/pipa.geojson')
    .then(r => r.json())
    .then(data => {
      const wilayahList = ['gianyar','sukawati','tampaksiring','blahbatuh','ubud','tegallalang','payangan'];
      const layerPipa = {}; // simpan layer per wilayah

      // Fungsi untuk menentukan warna berdasarkan diameter
      function warnaDiameter(diameter) {
        switch (diameter) {
          case 300: return 'green';
          case 250: return 'pink';
          case 200: return 'orange';
          case 150: return 'darkblue';
          case 100: return 'red';
          case 75:  return 'lightblue';
          case 50:  return 'yellow';
          case 40:  return 'darkgreen';
          case 25:  return 'brown';
          default:  return 'gray'; // bebas atau unknown
        }
      }

      wilayahList.forEach(wilayah => {
        const layer = L.geoJSON(data, {
          filter: f => (f.properties.cabang || '').toLowerCase() === wilayah,
          style: f => ({
            color: warnaDiameter(Number(f.properties.diameter)), // gunakan diameter untuk warna
            weight: .8
          }),
          onEachFeature: (f, l) => {
            l.bindPopup(`<b>Pipa</b><br>Wilayah: ${f.properties.cabang || '-'}<br>Diameter: ${f.properties.diameter || '-'}`);
          }
        });

        layerPipa[wilayah] = layer;
        layerControl.addOverlay(layer, `Pipa ${wilayah.charAt(0).toUpperCase() + wilayah.slice(1)}`);
      });

      // Simpan semua layer pipa ke global
      window.layerPipa = layerPipa;
    });
}

function loadDMA() {
  fetch('geojson/dma.geojson')
    .then(r => r.json())
    .then(data => {
      layerDMA = L.geoJSON(data, {
        style: f => ({
          color: '#333',
          weight: 1,
          fillColor: getZoneColor(f.properties.nama_zona || f.properties.zona),
          fillOpacity: 0.5
        }),
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>DMA:</b> ${f.properties.nama_zona || f.properties.zona || '-'}`);
        }
      });
      layerControl.addOverlay(layerDMA, "DMA");
      layerDMA.addTo(map);
    });
}

function loadSB() {
  fetch('geojson/sb.geojson')
    .then(r => r.json())
    .then(data => {
      const layerSB = L.geoJSON(data, {   // âœ… gunakan "data", bukan "sbData"
        pointToLayer: (f, latlng) =>
          L.marker(latlng, { icon: iconPng('sb.png') }),
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>SB:</b> ${f.properties.nama || '-'}`);
        }
      });
      layerControl.addOverlay(layerSB, "SB");
      layerSB.addTo(map);  // âœ… opsional: langsung tampil saat pertama kali load
    })
    .catch(err => console.error('Gagal load sb.geojson:', err));
}

function loadMAP() {
  fetch('geojson/map.geojson')
    .then(r => r.json())
    .then(data => {
      const layerMAP = L.geoJSON(data, {   // âœ… gunakan "data", bukan "sbData"
        pointToLayer: (f, latlng) =>
          L.marker(latlng, { icon: iconPng('map.png') }),
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>SB:</b> ${f.properties.nama || '-'}`);
        }
      });
      layerControl.addOverlay(layerMAP, "MAP");
      layerMAP.addTo(map);  // âœ… opsional: langsung tampil saat pertama kali load
    })
    .catch(err => console.error('Gagal load sb.geojson:', err));
}
function loadMAG() {
  fetch('geojson/mag.geojson')
    .then(r => r.json())
    .then(data => {
      const layerMAG = L.geoJSON(data, {
        pointToLayer: (f, latlng) => 
          L.marker(latlng, { icon: iconPng('mag.png') }),  // ðŸŸ¢ pakai ikon mag.png
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>MAG:</b> ${f.properties.nama || '-'}`);
        }
      });
      layerControl.addOverlay(layerMAG, "MAG");
      layerMAG.addTo(map); // opsional: tampilkan langsung di awal
    })
    .catch(err => console.error('Gagal memuat mag.geojson:', err));
}

function loadRES() {
  fetch('geojson/res.geojson')
    .then(r => r.json())
    .then(data => {
      const layerRES = L.geoJSON(data, {
        pointToLayer: (f, latlng) => 
          L.marker(latlng, { icon: iconPng('res.png') }),  // ðŸŸ¢ pakai ikon res.png
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>RES:</b> ${f.properties.nama || '-'}`);
        }
      });
      layerControl.addOverlay(layerRES, "RES");
      layerRES.addTo(map); // opsional: tampilkan langsung
    })
    .catch(err => console.error('Gagal memuat res.geojson:', err));
}


function loadGateValve() {
  fetch('geojson/gatevalve.geojson')
    .then(r => r.json())
    .then(data => {
      layerGate = L.geoJSON(data, {
        pointToLayer: (f, latlng) => {
          const putaran = (f.properties.putaran || '').toLowerCase();
          const iconFile = putaran === 'tf' ? 'Gv-TF.svg' : 'gv.png';

          // Icon inline dengan ukuran custom
          const icon = L.icon({
            iconUrl: `icons/simbol/${iconFile}`, // sesuaikan path
            iconSize: [5, 5],           // ukuran icon
            iconAnchor: [5, 5],         // titik anchor di bawah icon
            popupAnchor: [0, -6 ]         // popup muncul di atas icon
          });

          return L.marker(latlng, { icon: icon });
        },

        onEachFeature: (f, l) => {
          l.bindPopup(`<b>Gate Valve</b><br>Putaran: ${f.properties.putaran || '-'}`);
        }
      });

      layerControl.addOverlay(layerGate, "Gate Valve");
    });
}


function loadManometer() {
  fetch('geojson/manometer.geojson')
    .then(r => r.json())
    .then(data => {
      layerMano = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng, { icon: iconPng('mn.png') }),
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>Manometer</b><br>${f.properties.lokasi || '-'}`);
        }
      });
      layerControl.addOverlay(layerMano, "Manometer");
    });
}


// function loadVentile() {
//   fetch('geojson/ventile.geojson')
//     .then(r => r.json())
//     .then(data => {
//       const layerVentile = L.geoJSON(data, {
//         pointToLayer: (f, latlng) => 
//           L.marker(latlng, { icon: iconPng('vn.png') }),  // ikon kecil
//         onEachFeature: (f, l) => {
//           l.bindPopup(`<b>Ventile:</b> ${f.properties.nama || '-'}`);
//         }
//       });
//       layerControl.addOverlay(layerVentile, "Ventile");
     
//     })
//     .catch(err => console.error('Gagal memuat ventile.geojson:', err));
// }

function loadWMDistribusi() {
  fetch('geojson/wmdistribusi.geojson')
    .then(r => r.json())
    .then(data => {
      const layerWM = L.geoJSON(data, {
        pointToLayer: (f, latlng) =>
          L.marker(latlng, { icon: iconPng('Wm-DMA.svg') }),  // ikon PNG untuk WM
        onEachFeature: (f, l) => {
          l.bindPopup(`<b>WM Distribusi:</b> ${f.properties.nama || '-'}`);
        }
      });
      layerControl.addOverlay(layerWM, "WM Distribusi");
        layerWM.addTo(map); // opsional: tampilkan langsung
    })
    .catch(err => console.error('Gagal memuat wmdistribusi.geojson:', err));
}

// function loadWO() {
//   fetch('geojson/wo.geojson')
//     .then(r => r.json())
//     .then(data => {
//       layerWO = L.geoJSON(data, {
//         pointToLayer: (f, latlng) => L.marker(latlng, { icon: iconPng('wo.png') }),
//         onEachFeature: (f, l) => {
//           l.bindPopup(`<b>WO:</b> ${f.properties.nama || '-'}`);
//         }
//       });
//       layerControl.addOverlay(layerWO, "WO");
//     });
// }
</script>

<script>
function openCamera() {
  document.getElementById('cameraInput').click();
}

document.getElementById('cameraInput').addEventListener('change', e => {
  if (e.target.files[0]) ons.notification.toast('ðŸ“¸ Foto berhasil diambil!', { timeout: 1500 });
});
</script>


  
<script>
let marker; // deklarasi global
let trackingEnabled = true;
let watchID = null; // menyimpan ID watchPosition



const toggle = document.getElementById('toggleTracking');
toggle.addEventListener('change', function() {
  trackingEnabled = this.checked;

  if (trackingEnabled) {
    // Mulai watchPosition lagi
    if ('geolocation' in navigator) {
       marker.dragging.disable();
      watchID = navigator.geolocation.watchPosition(success, error, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      });
    }
  } else {
     marker.dragging.enable();
     // Event saat marker selesai di-drag
      marker.on('dragend', function(e) {
        const pos = marker.getLatLng(); // ambil posisi baru
        document.getElementById('status').textContent = `Koordinat: ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`;
        document.getElementById('accuracy').textContent = `Akurasi: Â±0 m`; // akurasi 0 saat manual
      });
      // Hentikan watchPosition
    if (watchID !== null) {
      navigator.geolocation.clearWatch(watchID);
      watchID = null;
      console.log("GPS tracking dihentikan");
    }
  }
});

// Fungsi success geolocation
function success(position) {
  const latitude = position.coords.latitude;
  const longitude = position.coords.longitude;
  const accuracy = position.coords.accuracy;

  document.getElementById('status').textContent = `Koordinat: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
  document.getElementById('accuracy').textContent = `Akurasi: Â±${accuracy} m`;

  // Update marker jika trackingEnabled
  if (trackingEnabled) {
   
    marker.setLatLng([latitude, longitude]);
    map.setView([latitude, longitude], 17);
  }
}

// Fungsi error
function error(err) {
  document.getElementById('status').textContent = `Gagal mendapatkan lokasi: ${err.message}`;
}

// Mulai tracking pertama kali
if ('geolocation' in navigator) {
  watchID = navigator.geolocation.watchPosition(success, error, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 5000
  });
} else {
  document.getElementById('status').textContent = 'Geolocation tidak didukung browser ini.';
}
</script>

</body>
</html>
